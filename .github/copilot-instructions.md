# Copilot Instructions for md-formatter

## Project Overview

`md-formatter` is a fast, opinionated Markdown formatter written in Rust. It provides:

- **CLI tool** (`mdfmt`) - installed via `cargo install md-formatter`
- **Node.js bindings** (`@rewdy/md-formatter`) - native addon via NAPI-RS

## Architecture

### Crate Structure

```
src/
├── lib.rs          # Public API exports and unit tests (25 tests)
├── main.rs         # CLI entry point
├── cli.rs          # clap argument parsing with ValueEnum enums
├── formatter.rs    # Core formatting logic (state machine, event processing)
├── parser.rs       # pulldown-cmark wrapper, frontmatter extraction
└── napi.rs         # Node.js bindings via NAPI-RS
```

### Cargo Features

- `cli` (default) - Enables CLI binary, clap, glob dependencies
- `napi` - Enables NAPI-RS bindings for Node.js

### Key Design Decisions

1. **Event stream processing** - Uses pulldown-cmark events directly, no full AST
2. **Hard breaks for idempotence** - Wrapped lines use `  \n` (two spaces) to prevent re-parsing issues
3. **State machine** - `Context` enum tracks current block type (paragraph, list, blockquote, etc.)
4. **Zero config philosophy** - Only `--width`, `--wrap`, and `--ordered-list` options

## Development Commands

```bash
# Run Rust tests
cargo test --lib

# Build CLI
cargo build --release

# Build NAPI bindings (regenerates index.js and index.d.ts)
pnpm build

# Bump version (updates Cargo.toml, package.json, npm/*/package.json, Cargo.lock)
pnpm bump <patch|minor|major> [--dry-run] [--commit]
```

## Important Files

- `index.js` / `index.d.ts` - **Auto-generated by NAPI-RS**. Run `pnpm build` after changing `src/napi.rs`
- `scripts/bump-version.mjs` - Version sync script for multi-package releases
- `.github/workflows/ci.yml` - Cross-platform builds, publishing to npm + crates.io

## Publishing Workflow

1. Run `pnpm bump patch --commit` (or minor/major)
2. Push: `git push && git push origin v<version>`
3. CI automatically:
   - Runs tests
   - Builds for 8 platforms
   - Publishes to crates.io
   - Publishes to npm
   - Creates GitHub Release

## Code Conventions

### Adding New Formatter Options

1. Add enum to `src/formatter.rs` with `FromStr` impl
2. Add CLI arg to `src/cli.rs` with `#[derive(ValueEnum)]`
3. Update `Formatter::with_options()` in `formatter.rs`
4. Add field to `FormatOptions` in `src/napi.rs`
5. Run `pnpm build` to regenerate TypeScript types
6. Add tests to `src/lib.rs`
7. Update README.md

### Testing

- All tests in `src/lib.rs` using `#[test]`
- Test idempotence: `format(format(x)) == format(x)`
- Run single test: `cargo test --lib test_name`

## Common Gotchas

1. **Forgetting `pnpm build`** - After changing `src/napi.rs`, regenerate `index.d.ts`
2. **Cargo.lock not updated** - The bump script handles this automatically
3. **CI verification** - CI will fail if generated files are out of sync

## Dependencies

| Crate | Purpose |
|-------|---------|
| pulldown-cmark 0.9 | Markdown parsing |
| clap 4.4 | CLI with derive macros |
| glob 0.3 | File pattern matching |
| napi 2 / napi-derive 2 | Node.js bindings |
